#!/bin/bash

# ==========================================
#  One Gate AI Server ìžë™ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸
# ==========================================

# 1. ë³€ìˆ˜ ì„¤ì • (ê²½ë¡œ ë° í¬íŠ¸)
PROJECT_DIR="/home/ubuntu/one-gate/backend"
LOG_FILE="$PROJECT_DIR/server.log"
PORT=8000

echo "ðŸš€ [1/4] ë°°í¬ë¥¼ ì‹œìž‘í•©ë‹ˆë‹¤..."

# 2. í”„ë¡œì íŠ¸ í´ë”ë¡œ ì´ë™
cd $PROJECT_DIR || { echo "âŒ í´ë” ì´ë™ ì‹¤íŒ¨"; exit 1; }

# 3. Git Pull (ìµœì‹  ì½”ë“œ ë°›ì•„ì˜¤ê¸°)
echo "ðŸ“¥ [2/4] ìµœì‹  ì½”ë“œë¥¼ ë°›ì•„ì˜µë‹ˆë‹¤ (git pull)..."
git pull

# 4. ê¸°ì¡´ ì„œë²„ ì¢…ë£Œ (í¬íŠ¸ 8000ë²ˆì„ ì“°ëŠ” í”„ë¡œì„¸ìŠ¤ ì°¾ì•„ì„œ ì£½ì´ê¸°)
# lsof -t -i:8000 ì€ PID ìˆ«ìžë§Œ ê¹”ë”í•˜ê²Œ ê°€ì ¸ì˜µë‹ˆë‹¤.
CURRENT_PID=$(lsof -t -i:$PORT)

if [ -z "$CURRENT_PID" ]; then
    echo "ðŸ“­ ì‹¤í–‰ ì¤‘ì¸ ì„œë²„ê°€ ì—†ì–´ ì¢…ë£Œ ì ˆì°¨ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
else
    echo "ðŸ›‘ [3/4] ê¸°ì¡´ ì„œë²„(PID: $CURRENT_PID)ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤..."
    kill -9 $CURRENT_PID
    sleep 2 # í™•ì‹¤ížˆ ì£½ì„ ë•Œê¹Œì§€ 2ì´ˆ ëŒ€ê¸°
fi

# 5. ì„œë²„ ìž¬ì‹œìž‘ (nohup)
echo "ðŸ”¥ [4/4] ì„œë²„ë¥¼ ìž¬ì‹œìž‘í•©ë‹ˆë‹¤..."
source venv/bin/activate
nohup uvicorn main:app --reload --host 0.0.0.0 --port $PORT > $LOG_FILE 2>&1 < /dev/null &

echo "âœ… ë°°í¬ ì™„ë£Œ! (ìž ì‹œ í›„ ë¡œê·¸ê°€ ì¶œë ¥ë©ë‹ˆë‹¤. ë‚˜ê°€ë ¤ë©´ Ctrl+C)"
echo "-------------------------------------------------------"
sleep 1
tail -f $LOG_FILE